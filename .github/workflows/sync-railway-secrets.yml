name: Sync Railway Secrets

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment to sync secrets'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview
          - all
      dry_run:
        description: 'Dry run (preview changes without applying)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

jobs:
  validate-secrets:
    name: Validate Required Secrets
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      has-secrets: ${{ steps.check.outputs.has-secrets }}
      missing-secrets: ${{ steps.check.outputs.missing-secrets }}
    
    steps:
      - name: Check required secrets
        id: check
        run: |
          MISSING_SECRETS=""
          ALL_SECRETS_PRESENT=true
          
          echo "ðŸ” Validating required secrets..."
          
          if [ -z "${{ secrets.RAILWAY_TOKEN }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}RAILWAY_TOKEN, "
            ALL_SECRETS_PRESENT=false
          fi
          
          if [ -z "${{ secrets.RAILWAY_PROJECT_ID }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}RAILWAY_PROJECT_ID, "
            ALL_SECRETS_PRESENT=false
          fi
          
          if [ -z "${{ secrets.SOLANA_RPC_URL }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}SOLANA_RPC_URL, "
            ALL_SECRETS_PRESENT=false
          fi
          
          if [ -z "${{ secrets.WALLET_PRIVATE_KEY }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}WALLET_PRIVATE_KEY, "
            ALL_SECRETS_PRESENT=false
          fi
          
          if [ -z "${{ secrets.ADMIN_USERNAME }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}ADMIN_USERNAME, "
            ALL_SECRETS_PRESENT=false
          fi
          
          if [ -z "${{ secrets.ADMIN_PASSWORD }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}ADMIN_PASSWORD, "
            ALL_SECRETS_PRESENT=false
          fi
          
          if [ -z "${{ secrets.JWT_SECRET }}" ]; then
            MISSING_SECRETS="${MISSING_SECRETS}JWT_SECRET, "
            ALL_SECRETS_PRESENT=false
          fi
          
          if [ "$ALL_SECRETS_PRESENT" = true ]; then
            echo "has-secrets=true" >> $GITHUB_OUTPUT
            echo "missing-secrets=" >> $GITHUB_OUTPUT
            echo "âœ… All required secrets are configured"
          else
            echo "has-secrets=false" >> $GITHUB_OUTPUT
            echo "missing-secrets=$MISSING_SECRETS" >> $GITHUB_OUTPUT
            echo "âš ï¸ Missing required secrets: $MISSING_SECRETS"
            echo "::warning::Missing required secrets: $MISSING_SECRETS"
            exit 1
          fi

  sync-secrets:
    name: Sync Secrets to Railway
    runs-on: ubuntu-latest
    needs: validate-secrets
    if: needs.validate-secrets.outputs.has-secrets == 'true'
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        
      - name: Install Railway CLI
        run: |
          echo "ðŸ“¦ Installing Railway CLI..."
          curl -fsSL https://railway.app/install.sh | sh
          echo "$HOME/.railway/bin" >> $GITHUB_PATH
          
      - name: Verify Railway CLI installation
        run: |
          railway --version
          echo "âœ… Railway CLI installed successfully"
          
      - name: Link to Railway project
        run: |
          echo "ðŸ”— Linking to Railway project..."
          railway link ${{ secrets.RAILWAY_PROJECT_ID }}
          echo "âœ… Project linked successfully"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          
      - name: Sync secrets (Dry Run)
        if: ${{ inputs.dry_run == true }}
        run: |
          echo "ðŸ” DRY RUN MODE - Preview of secrets that would be synced:"
          echo ""
          echo "Environment: ${{ inputs.environment }}"
          echo ""
          echo "Secrets to sync:"
          echo "  âœ“ SOLANA_RPC_URL (configured)"
          echo "  âœ“ WALLET_PRIVATE_KEY (configured)"
          echo "  âœ“ ADMIN_USERNAME (configured)"
          echo "  âœ“ ADMIN_PASSWORD (configured)"
          echo "  âœ“ JWT_SECRET (configured)"
          echo "  âœ“ NODE_ENV = production"
          echo "  âœ“ MINIMUM_PROFIT_SOL = 0.01"
          echo "  âœ“ MAX_SLIPPAGE = 0.01"
          echo "  âœ“ DEV_FEE_ENABLED = true"
          echo "  âœ“ DEV_FEE_PERCENTAGE = 0.10"
          echo "  âœ“ LOG_LEVEL = info"
          echo ""
          echo "â„¹ï¸ No changes were made. Run without dry_run to apply changes."
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          
      - name: Sync secrets to production
        if: ${{ inputs.dry_run == false && (inputs.environment == 'production' || inputs.environment == 'all') }}
        run: |
          echo "ðŸ”„ Syncing secrets to production environment..."
          
          # Core secrets
          railway variables --set SOLANA_RPC_URL="${{ secrets.SOLANA_RPC_URL }}"
          railway variables --set WALLET_PRIVATE_KEY="${{ secrets.WALLET_PRIVATE_KEY }}"
          railway variables --set ADMIN_USERNAME="${{ secrets.ADMIN_USERNAME }}"
          railway variables --set ADMIN_PASSWORD="${{ secrets.ADMIN_PASSWORD }}"
          railway variables --set JWT_SECRET="${{ secrets.JWT_SECRET }}"
          
          # Environment configuration
          railway variables --set NODE_ENV="production"
          railway variables --set LOG_LEVEL="info"
          
          # Trading parameters
          railway variables --set MINIMUM_PROFIT_SOL="0.01"
          railway variables --set MAX_SLIPPAGE="0.01"
          railway variables --set DEV_FEE_ENABLED="true"
          railway variables --set DEV_FEE_PERCENTAGE="0.10"
          
          echo "âœ… Production secrets synced successfully"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          
      - name: Sync secrets to preview
        if: ${{ inputs.dry_run == false && (inputs.environment == 'preview' || inputs.environment == 'all') }}
        run: |
          echo "ðŸ”„ Syncing secrets to preview environment..."
          
          # Core secrets (same as production)
          railway variables --set SOLANA_RPC_URL="${{ secrets.SOLANA_RPC_URL }}"
          railway variables --set WALLET_PRIVATE_KEY="${{ secrets.WALLET_PRIVATE_KEY }}"
          railway variables --set ADMIN_USERNAME="${{ secrets.ADMIN_USERNAME }}"
          railway variables --set ADMIN_PASSWORD="${{ secrets.ADMIN_PASSWORD }}"
          railway variables --set JWT_SECRET="${{ secrets.JWT_SECRET }}"
          
          # Environment configuration (preview-specific)
          railway variables --set NODE_ENV="preview"
          railway variables --set LOG_LEVEL="debug"
          
          # Trading parameters (more conservative for preview)
          railway variables --set MINIMUM_PROFIT_SOL="0.05"
          railway variables --set MAX_SLIPPAGE="0.005"
          railway variables --set DEV_FEE_ENABLED="false"
          
          echo "âœ… Preview secrets synced successfully"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          
      - name: Verify secrets
        if: ${{ inputs.dry_run == false }}
        run: |
          echo "ðŸ” Verifying secrets were set correctly..."
          railway variables | grep -E "NODE_ENV|LOG_LEVEL" || echo "Unable to verify secrets"
          echo "âœ… Verification complete"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          
      - name: Summary
        run: |
          echo "ðŸ“Š Secret Sync Summary"
          echo "====================="
          echo "Environment: ${{ inputs.environment }}"
          echo "Dry Run: ${{ inputs.dry_run }}"
          echo "Status: ${{ inputs.dry_run == true && 'Preview Only' || 'Applied' }}"
          echo ""
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "â„¹ï¸ This was a dry run. No changes were made."
            echo "Run the workflow again without dry_run to apply changes."
          else
            echo "âœ… Secrets have been synced to Railway."
            echo "Railway will automatically reload the application with new environment variables."
          fi
          
      - name: Create summary
        run: |
          echo "## ðŸ” Railway Secret Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "### â„¹ï¸ Dry Run Mode" >> $GITHUB_STEP_SUMMARY
            echo "No changes were applied. This was a preview only." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… Secrets Synced Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following secrets were synced:" >> $GITHUB_STEP_SUMMARY
            echo "- SOLANA_RPC_URL" >> $GITHUB_STEP_SUMMARY
            echo "- WALLET_PRIVATE_KEY" >> $GITHUB_STEP_SUMMARY
            echo "- ADMIN_USERNAME" >> $GITHUB_STEP_SUMMARY
            echo "- ADMIN_PASSWORD" >> $GITHUB_STEP_SUMMARY
            echo "- JWT_SECRET" >> $GITHUB_STEP_SUMMARY
            echo "- NODE_ENV" >> $GITHUB_STEP_SUMMARY
            echo "- LOG_LEVEL" >> $GITHUB_STEP_SUMMARY
            echo "- MINIMUM_PROFIT_SOL" >> $GITHUB_STEP_SUMMARY
            echo "- MAX_SLIPPAGE" >> $GITHUB_STEP_SUMMARY
            echo "- DEV_FEE_ENABLED" >> $GITHUB_STEP_SUMMARY
            echo "- DEV_FEE_PERCENTAGE" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸš‚ Railway will automatically reload with the new environment variables." >> $GITHUB_STEP_SUMMARY
          fi

  notify-on-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [validate-secrets, sync-secrets]
    if: failure()
    
    steps:
      - name: Create failure summary
        run: |
          echo "## âŒ Railway Secret Sync Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.validate-secrets.outputs.has-secrets }}" = "false" ]; then
            echo "### Missing Secrets" >> $GITHUB_STEP_SUMMARY
            echo "The following secrets are not configured:" >> $GITHUB_STEP_SUMMARY
            echo "${{ needs.validate-secrets.outputs.missing-secrets }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please configure all required secrets in repository settings." >> $GITHUB_STEP_SUMMARY
          else
            echo "### Sync Failed" >> $GITHUB_STEP_SUMMARY
            echo "An error occurred while syncing secrets to Railway." >> $GITHUB_STEP_SUMMARY
            echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
          fi
