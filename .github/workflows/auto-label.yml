name: Auto-label PRs

on:
  pull_request:
    types: [opened, reopened, synchronize]
  workflow_dispatch:
    inputs:
      apply_to_all_open_prs:
        description: "Also apply labels to all open PRs"
        type: boolean
        default: false

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  label-single:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Ensure labels exist
        uses: actions/github-script@v8
        with:
          script: |
            const labels = [
              { name: "auto-merge", color: "2ecc71", description: "Enable auto-merge when checks pass" },
              { name: "skip-deployment", color: "b31f45", description: "Skip deployment checks" },
            ];
            for (const l of labels) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: l.name,
                });
              } catch (e) {
                if (e.status === 404) {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: l.name,
                    color: l.color,
                    description: l.description,
                  });
                } else {
                  throw e;
                }
              }
            }
      - name: Add labels to this PR
        uses: actions/github-script@v8
        with:
          script: |
            const number = context.payload.pull_request.number;
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: number,
              labels: ["auto-merge", "skip-deployment"],
            });

  label-all-open:
    if: github.event_name == 'workflow_dispatch' && inputs.apply_to_all_open_prs == true
    runs-on: ubuntu-latest
    steps:
      - name: Ensure labels exist
        uses: actions/github-script@v8
        with:
          script: |
            const labels = [
              { name: "auto-merge", color: "2ecc71", description: "Enable auto-merge when checks pass" },
              { name: "skip-deployment", color: "b31f45", description: "Skip deployment checks" },
            ];
            for (const l of labels) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: l.name,
                });
              } catch (e) {
                if (e.status === 404) {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: l.name,
                    color: l.color,
                    description: l.description,
                  });
                } else {
                  throw e;
                }
              }
            }
      - name: Add labels to all open PRs
        uses: actions/github-script@v8
        with:
          script: |
            async function paginateAllOpenPRs() {
              const results = [];
              let page = 1;
              while (true) {
                const { data } = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: "open",
                  per_page: 100,
                  page,
                });
                results.push(...data);
                if (data.length < 100) break;
                page++;
              }
              return results;
            }

            const prs = await paginateAllOpenPRs();
            for (const pr of prs) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ["auto-merge", "skip-deployment"],
              });
            }
