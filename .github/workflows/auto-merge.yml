name: Auto-Merge When Ready

on:
  pull_request:
    types: [opened, reopened, synchronize, ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  gate-and-enable:
    runs-on: ubuntu-latest
    steps:
      - name: Gate and enable native auto-merge
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const number = context.payload.pull_request.number;
            const pr = (await github.rest.pulls.get({ owner, repo, pull_number: number })).data;

            const labels = pr.labels.map(l => l.name);
            if (!labels.includes("auto-merge")) {
              core.setFailed("Missing 'auto-merge' label.");
              return;
            }
            if (pr.draft) {
              core.setFailed("PR is draft.");
              return;
            }

            // Latest review states by user
            const reviews = await github.paginate(github.rest.pulls.listReviews, { owner, repo, pull_number: number });
            const latestByUser = new Map();
            for (const r of reviews) {
              if (r.user?.login) latestByUser.set(r.user.login, r);
            }
            const approvals = [...latestByUser.values()].filter(r => {
              const isBot = r.user?.type === "Bot" || r.user?.login?.endsWith("[bot]");
              return r.state === "APPROVED" && !isBot;
            });
            const changesRequested = [...latestByUser.values()].some(r => r.state === "CHANGES_REQUESTED");
            if (changesRequested) {
              core.setFailed("Changes requested.");
              return;
            }
            if (approvals.length < 1) {
              core.setFailed(`Not enough approvals (have ${approvals.length}, need 1).`);
              return;
            }

            // Enable native auto-merge (GitHub will merge when required checks are green)
            const prNodeId = pr.node_id;
            const mutation = `
              mutation($pullRequestId: ID!, $mergeMethod: PullRequestMergeMethod!) {
                enablePullRequestAutoMerge(input: { pullRequestId: $pullRequestId, mergeMethod: $mergeMethod }) {
                  pullRequest { number autoMergeRequest { enabledAt } }
                }
              }
            `;
            await github.graphql(mutation, { pullRequestId: prNodeId, mergeMethod: "SQUASH" });
            console.log(`âœ… Auto-merge enabled for PR #${number}. Will merge automatically when all checks pass.`);
