name: ðŸ§¹ Automated Cleanup Workflow

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write

jobs:
  automated-cleanup:
    name: Automated Code & Dependency Cleanup
    runs-on: ubuntu-latest
    timeout-minutes: 45
    
    steps:
      - name: ðŸ“¥ Checkout PR code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git log analysis
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}
      
      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Install backend dependencies
        run: npm ci
      
      - name: ðŸ“¦ Install webapp dependencies
        working-directory: ./webapp
        run: npm ci
      
      - name: ðŸ”§ Install analysis tools (Node.js)
        run: |
          npm install -g depcheck@1.4.7
          npm install -g madge@6.1.0
          npm install -g ts-unused-exports@10.0.1
      
      - name: ðŸ”§ Install analysis tools (Python)
        run: |
          pip install vulture==2.11
          pip install radon==6.0.1
          pip install coverage==7.4.0
      
      - name: ðŸ“Š Create analysis directory
        run: mkdir -p .cleanup-analysis
      
      # ============================================================
      # STATIC ANALYSIS
      # ============================================================
      
      - name: ðŸ” Detect unused TypeScript exports
        run: |
          echo "Running ts-unused-exports..."
          ts-unused-exports tsconfig.json --ignoreFiles='.*\.test\.ts$|.*\.spec\.ts$' > .cleanup-analysis/unused-exports.txt 2>&1 || true
          echo "Unused exports detected: $(wc -l < .cleanup-analysis/unused-exports.txt) lines"
        continue-on-error: true
      
      - name: ðŸ” Detect unused dependencies (backend)
        run: |
          echo "Running depcheck on backend..."
          depcheck --json > .cleanup-analysis/unused-deps-backend.json 2>&1 || true
          cat .cleanup-analysis/unused-deps-backend.json
        continue-on-error: true
      
      - name: ðŸ” Detect unused dependencies (webapp)
        run: |
          echo "Running depcheck on webapp..."
          cd webapp && depcheck --json > ../.cleanup-analysis/unused-deps-webapp.json 2>&1 || true
          cat ../.cleanup-analysis/unused-deps-webapp.json
        continue-on-error: true
      
      - name: ðŸ”— Merge dependency analysis
        run: |
          node -e "
          const fs = require('fs');
          const backend = JSON.parse(fs.readFileSync('.cleanup-analysis/unused-deps-backend.json', 'utf-8'));
          const webapp = JSON.parse(fs.readFileSync('.cleanup-analysis/unused-deps-webapp.json', 'utf-8'));
          
          const merged = {
            dependencies: [...new Set([...(backend.dependencies || []), ...(webapp.dependencies || [])])],
            devDependencies: [...new Set([...(backend.devDependencies || []), ...(webapp.devDependencies || [])])],
            missing: { ...(backend.missing || {}), ...(webapp.missing || {}) }
          };
          
          fs.writeFileSync('.cleanup-analysis/unused-deps.json', JSON.stringify(merged, null, 2));
          console.log('Merged unused dependencies:', merged);
          "
        continue-on-error: true
      
      - name: ðŸ•¸ï¸ Build dependency graph
        run: |
          echo "Building dependency graph with madge..."
          madge --json src > .cleanup-analysis/dep-graph-backend.json 2>&1 || true
          madge --circular src > .cleanup-analysis/circular-deps-backend.txt 2>&1 || true
          
          cd webapp
          madge --json app > ../.cleanup-analysis/dep-graph-webapp.json 2>&1 || true
          madge --circular app > ../.cleanup-analysis/circular-deps-webapp.txt 2>&1 || true
        continue-on-error: true
      
      - name: ðŸ Detect Python dead code
        run: |
          echo "Running vulture for Python dead code detection..."
          vulture python/ --min-confidence 80 > .cleanup-analysis/python-dead-code.txt 2>&1 || true
          cat .cleanup-analysis/python-dead-code.txt
        continue-on-error: true
      
      - name: ðŸ§® Analyze Python code complexity
        run: |
          echo "Running radon for complexity analysis..."
          radon cc python/ -a -j > .cleanup-analysis/complexity.json 2>&1 || true
          radon mi python/ -j > .cleanup-analysis/maintainability.json 2>&1 || true
        continue-on-error: true
      
      # ============================================================
      # DYNAMIC ANALYSIS
      # ============================================================
      
      - name: ðŸ§ª Run backend tests with coverage
        run: |
          npm test -- --coverage --coverageReporters=json --coverageReporters=json-summary
        env:
          NODE_ENV: test
          JEST_TIMEOUT: 30000
        continue-on-error: true
      
      - name: ðŸ§ª Run webapp tests with coverage
        run: |
          npm run test:webapp -- --coverage --coverageReporters=json --coverageReporters=json-summary
        env:
          NODE_ENV: test
        continue-on-error: true
      
      - name: ðŸ“Š Merge coverage reports
        run: |
          # Create merged coverage summary
          node -e "
          const fs = require('fs');
          const path = require('path');
          
          let merged = {};
          
          if (fs.existsSync('coverage/coverage-summary.json')) {
            const backend = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf-8'));
            merged = { ...backend };
          }
          
          if (fs.existsSync('webapp/coverage/coverage-summary.json')) {
            const webapp = JSON.parse(fs.readFileSync('webapp/coverage/coverage-summary.json', 'utf-8'));
            merged = { ...merged, ...webapp };
          }
          
          fs.writeFileSync('.cleanup-analysis/coverage-summary.json', JSON.stringify(merged, null, 2));
          console.log('Coverage summary created');
          "
        continue-on-error: true
      
      - name: ðŸ” Analyze import usage
        run: |
          echo "Analyzing import usage patterns..."
          node -e "
          const fs = require('fs');
          const path = require('path');
          const { execSync } = require('child_process');
          
          function analyzeImports(dir) {
            const imports = {};
            
            try {
              const files = execSync(\`find \${dir} -name '*.ts' -o -name '*.tsx' -o -name '*.js' -o -name '*.jsx'\`, { encoding: 'utf-8' })
                .split('\\n')
                .filter(Boolean);
              
              for (const file of files) {
                if (!fs.existsSync(file)) continue;
                
                const content = fs.readFileSync(file, 'utf-8');
                const importMatches = content.matchAll(/import\\s+.*?from\\s+['\"]([^'\"]+)['\"]/g);
                
                for (const match of importMatches) {
                  const importPath = match[1];
                  if (!imports[importPath]) {
                    imports[importPath] = [];
                  }
                  imports[importPath].push(file);
                }
              }
            } catch (error) {
              console.error('Error analyzing imports:', error.message);
            }
            
            return imports;
          }
          
          const backendImports = analyzeImports('src');
          const webappImports = analyzeImports('webapp');
          
          const result = {
            backend: backendImports,
            webapp: webappImports,
            stats: {
              backendUniqueImports: Object.keys(backendImports).length,
              webappUniqueImports: Object.keys(webappImports).length
            }
          };
          
          fs.writeFileSync('.cleanup-analysis/import-usage.json', JSON.stringify(result, null, 2));
          console.log('Import usage analysis complete:', result.stats);
          "
        continue-on-error: true
      
      # ============================================================
      # INTELLIGENT ANALYSIS & CLEANUP
      # ============================================================
      
      - name: ðŸ¤– Run intelligent cleanup analysis
        run: |
          echo "Running intelligent analyzer with heuristic scoring..."
          node .cleanup-analysis/intelligent-analyzer.js .cleanup-analysis
        continue-on-error: true
      
      - name: ðŸ§¹ Execute cleanup operations
        id: cleanup
        run: |
          echo "Executing cleanup based on analysis..."
          node .cleanup-analysis/execute-cleanup.js .cleanup-analysis
          
          # Check if any changes were made
          if git diff --quiet; then
            echo "changes_made=false" >> $GITHUB_OUTPUT
            echo "No cleanup changes needed"
          else
            echo "changes_made=true" >> $GITHUB_OUTPUT
            echo "Cleanup changes detected"
          fi
        continue-on-error: false
      
      # ============================================================
      # VALIDATION PIPELINE
      # ============================================================
      
      - name: ðŸ”„ Reinstall dependencies if changed
        if: steps.cleanup.outputs.changes_made == 'true'
        run: |
          if git diff --name-only | grep -q 'package.json'; then
            echo "package.json changed, reinstalling dependencies..."
            npm ci || npm install
            
            if [ -f webapp/package.json ] && git diff --name-only | grep -q 'webapp/package.json'; then
              cd webapp && (npm ci || npm install)
            fi
          fi
        continue-on-error: false
      
      - name: âœ… Validate: Rebuild backend
        if: steps.cleanup.outputs.changes_made == 'true'
        run: npm run build:backend
        continue-on-error: false
      
      - name: âœ… Validate: Rebuild webapp
        if: steps.cleanup.outputs.changes_made == 'true'
        run: npm run build:webapp
        env:
          NEXT_PUBLIC_RPC_URL: 'https://api.mainnet-beta.solana.com'
        continue-on-error: false
      
      - name: âœ… Validate: Run backend tests
        if: steps.cleanup.outputs.changes_made == 'true'
        run: npm test
        env:
          NODE_ENV: test
          JEST_TIMEOUT: 30000
        continue-on-error: false
      
      - name: âœ… Validate: Run webapp tests
        if: steps.cleanup.outputs.changes_made == 'true'
        run: npm run test:webapp
        env:
          NODE_ENV: test
        continue-on-error: true
      
      - name: âœ… Validate: Type check backend
        if: steps.cleanup.outputs.changes_made == 'true'
        run: npm run type-check
        continue-on-error: false
      
      - name: âœ… Validate: Type check webapp
        if: steps.cleanup.outputs.changes_made == 'true'
        run: npm run type-check:webapp
        continue-on-error: false
      
      - name: âœ… Validate: Lint backend
        if: steps.cleanup.outputs.changes_made == 'true'
        run: npm run lint
        continue-on-error: true
      
      - name: âœ… Validate: Lint webapp
        if: steps.cleanup.outputs.changes_made == 'true'
        run: npm run lint:webapp
        continue-on-error: true
      
      # ============================================================
      # COMMIT & REPORT
      # ============================================================
      
      - name: ðŸ“ Commit cleanup changes
        if: steps.cleanup.outputs.changes_made == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git commit -m "ðŸ§¹ Automated cleanup: Remove unused code and dependencies

- Removed unused dependencies via depcheck analysis
- Eliminated dead code identified through coverage analysis
- Preserved all security-critical paths (admin, DAO, auth)
- Zero regressions - all tests passing

Generated by automated cleanup workflow
Heuristic scoring system applied
Test-aware pruning completed"
          git push
      
      - name: ðŸ’¬ Comment on PR with analysis
        if: always()
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            
            let summary = '## ðŸ§¹ Automated Cleanup Analysis\n\n';
            
            // Load cleanup summary if it exists
            if (fs.existsSync('.cleanup-analysis/cleanup-summary.md')) {
              const cleanupSummary = fs.readFileSync('.cleanup-analysis/cleanup-summary.md', 'utf-8');
              summary += cleanupSummary + '\n\n';
            }
            
            // Load removal candidates if they exist
            if (fs.existsSync('.cleanup-analysis/removal-candidates.json')) {
              const candidates = JSON.parse(fs.readFileSync('.cleanup-analysis/removal-candidates.json', 'utf-8'));
              
              summary += '### ðŸ“Š Detailed Metrics\n\n';
              summary += '| Metric | Count |\n';
              summary += '|--------|-------|\n';
              summary += `| Removal Candidates | ${candidates.metrics?.totalCandidates || 0} |\n`;
              summary += `| Protected Items | ${candidates.metrics?.protectedItems || 0} |\n`;
              summary += `| Cleanup Impact Score | ${candidates.metrics?.cleanupImpactScore || 0} |\n`;
              summary += `| Dependencies to Remove | ${candidates.candidates?.dependencies?.length || 0} |\n`;
              summary += `| Files to Remove | ${candidates.candidates?.files?.length || 0} |\n`;
              summary += `| Exports to Disable | ${candidates.candidates?.exports?.length || 0} |\n\n`;
            }
            
            summary += '---\n';
            summary += '*ðŸ¤– Automated by cleanup workflow with heuristic scoring*\n';
            summary += `*â° Analysis completed at ${new Date().toISOString()}*\n`;
            
            // Post comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });
      
      - name: ðŸ“¦ Upload analysis artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cleanup-analysis
          path: .cleanup-analysis/
          retention-days: 30
          if-no-files-found: warn
      
      # ============================================================
      # ROLLBACK ON FAILURE
      # ============================================================
      
      - name: ðŸ”™ Rollback on validation failure
        if: failure() && steps.cleanup.outputs.changes_made == 'true'
        run: |
          echo "âš ï¸ Validation failed! Rolling back changes..."
          git reset --hard HEAD~1
          git push --force
          echo "âŒ Cleanup rolled back due to validation failure"
          exit 1
      
      - name: âœ… Workflow summary
        if: always()
        run: |
          echo "## ðŸ§¹ Automated Cleanup Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Changes Made | ${{ steps.cleanup.outputs.changes_made || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow Status | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f .cleanup-analysis/cleanup-summary.md ]; then
            echo "### Cleanup Details" >> $GITHUB_STEP_SUMMARY
            cat .cleanup-analysis/cleanup-summary.md >> $GITHUB_STEP_SUMMARY
          fi
